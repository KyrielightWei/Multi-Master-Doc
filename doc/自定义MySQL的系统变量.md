# 自定义MySQL的系统变量

在基于mysql进行二次开发时，需要添加一些我们自己的配置项，比如网络传输需要的配置文件路径。这就需要我们添加配置文件中的项，并且可以在mysql启动时读取到mysql进程中保存。

MySQL server启动的源码是在`mysqld.cc`的mysqld_main函数中。启动的第一部分流程即是读取mysql配置文件和传入的命令行参数，基于命令行参数优先配置文件的原则更新系统变量，用于后续的启动。

## 配置组

mysql中的配置是按组分开的，mysqld在启动时只会读取指定组的配置项，其余组的配置会被忽略。

`load_defaults`函数的作用即是对配置项的预处理，筛选出指定组的配置项，将其添加到命令行参数中，用于后续的系统变量更新。mysqld的配置组定义如下：

```c++
const char *load_default_groups[] = {
#ifdef WITH_NDBCLUSTER_STORAGE_ENGINE
    "mysql_cluster",
#endif
    "multi-master","mysqld",        "server", MYSQL_BASE_VERSION, 0, 0};
```

`"multi-master"`就是我们添加的自己的配置组，这样还不够，仅仅是添加配置组，mysqld启动后会返回1并终止。（由于无法找到配置项对应的系统变量）

## 全局系统变量（server）

按照mysql源码中的定义，系统变量分为全局级和session级，关于这种分类方式有很多资料说明，可以自行查询。

这里我们对系统变量按照初始化的位置分类，可以分为server级、存储引擎级、插件级。我们先介绍server级的全局变量，插件级与存储引擎级与之类似，区别在于初始化的时间不同。

之前也提到过，mysql读取配置文件后结合命令行参数生成新的命令行参数变量argv与argc，后续经过一系列复杂处理后会添加到系统变量哈希表中，其中包含了许多用于实现SET和SHOW命令的代码逻辑，在此不赘述。对于添加配置项这个目的来说，只需要添加与配置项同名的系统变量即可，mysql原本的代码逻辑会将配置项的值更新到系统变量。

mysql的系统变量设计十分有意思，它有一种很少见的设计模式，全局的系统变量链表`all_sys_var`搭配构造函数中的链表添加逻辑。添加新的系统变量需要两步：

1. 在`percona-server/sql/sys_vars.cc`文件中构造一个静态系统变量，构造方法可以参考相似类别的系统变量。
2. 在`sql/mysqld.cc`中定义用于存放系统变量的全局变量，`sql/mysqld.h`中声明变量的extern声明，这一变量在上面的定义中是需要的，作为构造函数的参数。

mysql启动时会将配置加载到全局变量，需要使用时包含`mysqld.h`头文件，然后直接引用全局变量即可。

注意：这一方式添加的系统变量是全局有效的，且可用于任何存储引擎和插件，需要谨慎。存在问题的系统变量可能会引起进程的崩溃。